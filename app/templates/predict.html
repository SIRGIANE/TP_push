{% extends "base.html" %}

{% block title %}Pr√©diction{% endblock %}

{% block content %}
<div class="card">
    <h2>üîÆ Faire une Pr√©diction</h2>
    
    {% if not model_loaded %}
    <div class="alert alert-error">
        <strong>‚ö†Ô∏è Aucun mod√®le charg√©!</strong>
        <p>Veuillez d'abord <a href="/train_model" style="color: #721c24; text-decoration: underline;">entra√Æner un mod√®le</a>.</p>
    </div>
    {% else %}
    <div class="alert alert-info">
        <strong>‚úì Mod√®le actuel:</strong> {{ model_name }}
    </div>
    
    <form id="predictForm">
        <div class="form-group">
            <label>Source des Donn√©es</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="data_source" value="random" checked style="width: auto; margin-right: 8px;">
                    üé≤ Donn√©es Al√©atoires
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="data_source" value="test_sample" style="width: auto; margin-right: 8px;">
                    üß™ √âchantillon de Test
                </label>
            </div>
        </div>
        
        <button type="submit" class="btn">üîÆ Pr√©dire</button>
    </form>
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #667eea; font-weight: 500;">Pr√©diction en cours...</p>
    </div>
    
    <div id="result" style="display: none;"></div>
    <div id="error" style="display: none;" class="alert alert-error"></div>
    {% endif %}
</div>

<script>
    const predictForm = document.getElementById('predictForm');
    const loading = document.getElementById('loading');
    const result = document.getElementById('result');
    const error = document.getElementById('error');
    
    if (predictForm) {
        predictForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            loading.classList.add('show');
            result.style.display = 'none';
            error.style.display = 'none';
            
            const formData = new FormData(predictForm);
            
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Afficher le r√©sultat
                const isMalignant = data.prediction_value === 1;
                const resultClass = isMalignant ? 'malignant' : 'benign';
                
                let html = `
                    <div class="prediction-result ${resultClass}">
                        <h2>${data.prediction}</h2>
                        <p style="font-size: 1.2em; margin: 10px 0;">
                            ${isMalignant ? '‚ö†Ô∏è Tumeur Maligne D√©tect√©e' : '‚úì Tumeur B√©nigne'}
                        </p>
                        
                        <div style="margin: 30px 0;">
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Probabilit√© B√©nigne</span>
                                    <span><strong>${(data.prob_benign * 100).toFixed(2)}%</strong></span>
                                </div>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${data.prob_benign * 100}%;">
                                        ${(data.prob_benign * 100).toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Probabilit√© Maligne</span>
                                    <span><strong>${(data.prob_malignant * 100).toFixed(2)}%</strong></span>
                                </div>
                                <div class="probability-bar">
                                    <div class="probability-fill" style="width: ${data.prob_malignant * 100}%;">
                                        ${(data.prob_malignant * 100).toFixed(1)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${data.true_label ? `
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin-top: 20px;">
                                <strong>Vraie Valeur:</strong> ${data.true_label}
                                ${data.correct ? 
                                    '<span style="margin-left: 10px;">‚úÖ Pr√©diction Correcte</span>' : 
                                    '<span style="margin-left: 10px;">‚ùå Pr√©diction Incorrecte</span>'
                                }
                            </div>
                        ` : ''}
                        
                        <p style="margin-top: 20px; font-size: 0.95em; opacity: 0.9;">
                            ${isMalignant ? 
                                '‚ö†Ô∏è Recommandation: Consultation m√©dicale imm√©diate requise' : 
                                '‚úì Recommandation: Suivi m√©dical r√©gulier conseill√©'
                            }
                        </p>
                    </div>
                `;
                
                result.innerHTML = html;
                result.style.display = 'block';
                
            } catch (err) {
                error.textContent = `‚ùå Erreur: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.classList.remove('show');
            }
        });
    }
</script>
{% endblock %}
